#!/bin/sh

clear

. build.env

test -x "${SOFIN_BIN}" && \
    ${SOFIN_BIN} disable && \
    echo "Sofin environment disabled"

test -f "${SOFIN_DATA_DIR}/loader" && \
    . "${SOFIN_DATA_DIR}/loader" && \
    echo "Loaded ${SOFIN_DATA_DIR}/loader"


test -f "${BUILD_NUMBER_FILE}" || echo "1" > "${BUILD_NUMBER_FILE}"
export BUILD_NUMBER="$(echo "$(cat "${BUILD_NUMBER_FILE}" 2>/dev/null)+1" | bc 2>/dev/null)"
export VERSION="${VERSION_MAJOR}.${SYSTEM_VERSION}.${BUILD_NUMBER}"

echo "BUILD no: ${BUILD_NUMBER}"
echo "${BUILD_NUMBER}" > "${BUILD_NUMBER_FILE}"

${INSTALL_BIN} -v etc/make.conf /etc/
${INSTALL_BIN} -v etc/src.conf /etc/

# test -z "${DEVEL}" && \
#     git reset --hard
case ${ARCH} in
    arm)
        sed -i '' -e 's/^COPTFLAGS.*$/COPTFLAGS=-O2 -pipe -ffast-math -fno-strict-aliasing -mcpu=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard/' etc/make.conf
        sed -i '' -e 's/^CPUTYPE.*$/CPUTYPE?=armv6/' etc/make.conf
        sed -i '' -e 's/^CFLAGS.*$/CFLAGS=-O2 -pipe -fno-omit-frame-pointer -fno-strict-aliasing -mcpu=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard/' etc/make.conf
        ;;

    amd64|x86_64)
        ;;

    *)
        printf "Error: Architecture not supported: ${ARCH}.\n"
        exit 1
        ;;
esac

echo "Cleaning /usr/src"
${RM_BIN} -rf /usr/src

set -e
echo "Pedantic mode enabled!"

. build.env
. build-jail-base
. build-binary-snapshots

echo "Build #${BUILD_NUMBER} in progressâ€¦"
build_base

echo "Commiting a snapshot of the build #${BUILD_NUMBER_FILE}"
commit_snapshots_build

set +e

# test -z "${DEVEL}" && \
#     git reset --hard
