#!/bin/sh


LAUNCH_ARGS="$*"

test -x /usr/bin/s && s disable
. /usr/share/sofin/loader

. build.env


test -f "${BUILD_NUMBER_FILE}" || echo "1" > "${BUILD_NUMBER_FILE}"
export BUILD_NUMBER="$(echo "$(cat "${BUILD_NUMBER_FILE}" 2>/dev/null)+1" | bc 2>/dev/null)"
export VERSION="${VERSION_MAJOR}.${OS_VER}.${BUILD_NUMBER}"

echo "BUILD no: ${BUILD_NUMBER}"
echo "${BUILD_NUMBER}" > "${BUILD_NUMBER_FILE}"

${INSTALL_BIN} -v etc/make.conf /etc/
${INSTALL_BIN} -v etc/src.conf /etc/

# test -z "${DEVEL}" && \
#     git reset --hard
case ${ARCH} in
    arm)
        sed -i '' -e 's/^COPTFLAGS.*$/COPTFLAGS=-O2 -pipe -ffast-math -fno-strict-aliasing -mcpu=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard/' etc/make.conf
        sed -i '' -e 's/^CPUTYPE.*$/CPUTYPE?=armv6/' etc/make.conf
        sed -i '' -e 's/^CFLAGS.*$/CFLAGS=-O2 -pipe -fno-omit-frame-pointer -fno-strict-aliasing -mcpu=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard/' etc/make.conf
        ;;

    amd64|x86_64)
        ;;

    *)
        printf "Error: Architecture not supported: ${ARCH}.\n"
        exit 1
        ;;
esac

unset CC CPP CXX CFLAGS CXXFLAGS LDFLAGS MANPATH PATH PKG_CONFIG_PATH MAIL
export PATH

set -e

. ./build-jail-base
. ./build-binary-snapshots

build_base
commit_snapshots_build

set +e

# test -z "${DEVEL}" && \
#     git reset --hard
