#!/bin/sh

if [ "${VERSION}" = "" ]; then
    VERSION="v0.4.1"
fi
BASE="ServeD-OS-Base"
LOG="/var/log/svd-install.log"

# sanity checks
test ! -d /Users && mkdir /Users

cd /
fetch http://dmilith.verknowsys.com/Public/9.3/${BASE}-${VERSION}.tar.xz
if [ "$?" != "0" ]; then
    echo "Binary snapshot isn't available, or something just went wrong while fetching archive"
    exit 1
fi

tar xf ${BASE}-${VERSION}.tar.xz

if [ "$?" != "0" ]; then
    echo "Binary snapshot corrupted or something just went wrong with archive"
    exit 1
fi

echo "Installation process started" > ${LOG}
. /etc/sofin.conf.sh
note "Sofin configuration loaded"

if [ "${SHELL}" != "/Software/Zsh/exports/zsh" ]; then
    note "Setting ZSH shell"
    printf "/Software/Zsh/exports/zsh\n" >> /etc/shells
    chsh -s /Software/Zsh/exports/zsh >> ${LOG} 2>&1
fi

if [ ! -d "/SystemUsers" ]; then
    note "Setting root home dir to /SystemUsers"
    mv /root /SystemUsers
    pw user mod root -d /SystemUsers >> ${LOG} 2>&1
fi

note "Setting up shell environment"
cp -v /etc/zshenv.served /etc/zshenv >> ${LOG} 2>&1

note "Installing igniters"
/Software/Thess/exports/ignitersinstall >> ${LOG} 2>&1

note "Starting Ntp service"
test -d /SystemUsers/SoftwareData/Ntp || mkdir -p /SystemUsers/SoftwareData/Ntp
test -f /SystemUsers/SoftwareData/Ntp/.running || touch /SystemUsers/SoftwareData/Ntp/.start

note "Starting LiveUsers service"
test -d /SystemUsers/SoftwareData/LiveUsers || mkdir -p /SystemUsers/SoftwareData/LiveUsers
test -f /SystemUsers/SoftwareData/LiveUsers/.running || touch /SystemUsers/SoftwareData/LiveUsers/.start

note "Setting up default boot loader configuration"
cp -v /etc/loader.conf.served /boot/loader.conf >> ${LOG} 2>&1

note "Setting up sysctl"
cp -v /etc/sysctl.conf.served /etc/sysctl.conf >> ${LOG} 2>&1
service sysctl reload

note "Setting up rc configuration"
cat /etc/rc.conf.served >> /etc/rc.conf

note "Cleaning shared memory state and semaphores"
ipcrm -W

note "Disabling core dumps"
ulimit -c 0
echo "ulimit -c 0" >> /etc/zshenv

note "Reloading core services"
cp -v /etc/ttys.served /etc/ttys >> ${LOG} 2>&1
kill -HUP 1

note "Cleaning up"
rm -rfv /${BASE}-${VERSION}.tar.xz >> ${LOG} 2>&1
note "ServeD system installation complete."
